<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mensagens Programadas | 2D Consultores</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#1a1a1a;--accent:#2563eb;--accent-dark:#1e40af;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;
  --border:#e5e7eb;--text-dark:#111827;--text-secondary:#6b7280;--bg-light:#f9fafb;--bg-card:#ffffff;
}
*{font-family:'Inter',system-ui,-apple-system,'Segoe UI',sans-serif}
html,body{background:var(--bg-light);min-height:100vh;color:var(--text-dark)}
.main-container{max-width:1400px;margin:0 auto;padding:32px 20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:40px;padding-bottom:24px;border-bottom:1px solid var(--border)}
.header-content h1{margin:0;font-size:32px;font-weight:700;color:var(--text-dark);display:flex;align-items:center;gap:12px}
.header-content p{margin:8px 0 0 0;color:var(--text-secondary);font-size:14px}
.back-button{background:transparent;border:1px solid var(--border);color:var(--text-secondary);padding:10px 20px;border-radius:8px;font-size:14px;font-weight:500;transition:.2s;text-decoration:none;cursor:pointer}
.back-button:hover{background:var(--bg-light);color:var(--accent);border-color:var(--accent)}

.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:40px}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:24px;transition:.2s}
.stat-card:hover{border-color:var(--accent);box-shadow:0 4px 12px rgba(37,99,235,.08)}
.stat-icon{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:16px}
.stat-icon.primary{background:rgba(37,99,235,.1);color:var(--accent)}
.stat-icon.success{background:rgba(16,185,129,.1);color:var(--success)}
.stat-icon.warning{background:rgba(245,158,11,.1);color:var(--warning)}
.stat-value{font-size:28px;font-weight:700;margin:0 0 8px}
.stat-label{font-size:13px;color:var(--text-secondary);font-weight:500}

.nav-tabs{border-bottom:1px solid var(--border);margin-bottom:0}
.nav-link{border:none;color:var(--text-secondary);font-weight:500;font-size:14px;padding:16px 24px;border-bottom:2px solid transparent;transition:.2s;cursor:pointer}
.nav-link:hover{color:var(--accent);border-bottom-color:var(--accent)}
.nav-link.active{color:var(--accent);border-bottom-color:var(--accent);background:none}

.content-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:32px;margin-bottom:20px}
.content-card h3{font-size:18px;font-weight:700;margin-bottom:24px;color:var(--text-dark);display:flex;align-items:center;gap:10px}

.btn-primary-custom{background:var(--accent);color:white;border:none;padding:10px 24px;border-radius:8px;font-weight:600;font-size:14px;transition:.2s;cursor:pointer}
.btn-primary-custom:hover{background:var(--accent-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(37,99,235,.3);color:white}
.btn-primary-custom:disabled{background:#d1d5db;cursor:not-allowed;transform:none}
.btn-success-custom{background:var(--success);color:white;border:none;padding:12px 28px;border-radius:8px;font-weight:600;font-size:16px;transition:.2s;cursor:pointer;width:100%}
.btn-success-custom:hover{background:#059669;transform:translateY(-2px);box-shadow:0 4px 12px rgba(16,185,129,.3);color:white}
.btn-secondary-custom{background:transparent;color:var(--text-secondary);border:1px solid var(--border);padding:10px 24px;border-radius:8px;font-weight:500;font-size:14px;transition:.2s;cursor:pointer}
.btn-secondary-custom:hover{background:var(--bg-light);border-color:var(--text-secondary)}
.btn-danger-outline{background:transparent;color:var(--danger);border:1px solid var(--danger);padding:10px 24px;border-radius:8px;font-weight:600;font-size:14px;transition:.2s;cursor:pointer}
.btn-danger-outline:hover{background:rgba(239,68,68,.1)}

.form-group{margin-bottom:24px}
.form-label{font-weight:600;font-size:14px;color:var(--text-dark);margin-bottom:8px;display:block}
.form-control,.form-select{border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:14px;transition:.2s;background:var(--bg-card)}
.form-control:focus,.form-select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.1);outline:none}
.form-control::placeholder{color:var(--text-secondary)}
textarea.form-control{resize:vertical;min-height:120px;font-family:'Inter',sans-serif}

.empty-state{text-align:center;padding:60px 20px}
.empty-state i{font-size:64px;color:#d1d5db;margin-bottom:20px}
.empty-state p{color:var(--text-secondary);font-size:14px;margin-bottom:20px}

.loading-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;justify-content:center;align-items:center}
.spinner-custom{width:50px;height:50px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.table{font-size:14px;margin-bottom:0}
.table thead{background:var(--bg-light);border-bottom:1px solid var(--border)}
.table thead th{font-weight:600;color:var(--text-secondary);border:none;padding:12px 16px}
.table tbody td{padding:12px 16px;border-bottom:1px solid var(--border)}

.badge-pill{border:1px solid var(--border);padding:10px 12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay"><div class="spinner-custom"></div></div>

<div class="main-container">
  <div class="header">
    <div class="header-content">
      <h1><i class="bi bi-broadcast"></i> Mensagens Programadas</h1>
      <p>Gerencie seus clientes via Excel e envie mensagens personalizadas</p>
    </div>
    <a href="/home" class="back-button"><i class="bi bi-arrow-left"></i> Voltar</a>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon primary"><i class="bi bi-person-lines-fill"></i></div>
      <p class="stat-value" id="totalClientes">0</p>
      <p class="stat-label">Total de Clientes</p>
    </div>
    <div class="stat-card">
      <div class="stat-icon warning"><i class="bi bi-envelope-fill"></i></div>
      <p class="stat-value" id="totalMensagens">0</p>
      <p class="stat-label">Mensagens Criadas</p>
    </div>
    <div class="stat-card">
      <div class="stat-icon success"><i class="bi bi-send-check-fill"></i></div>
      <p class="stat-value" id="totalEnviadas">0</p>
      <p class="stat-label">Mensagens Enviadas</p>
    </div>
  </div>

  <ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="clientes-tab" data-bs-toggle="pill" data-bs-target="#clientes" type="button" role="tab">
        <i class="bi bi-people-fill me-2"></i>Clientes
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="mensagens-tab" data-bs-toggle="pill" data-bs-target="#mensagens" type="button" role="tab">
        <i class="bi bi-envelope-fill me-2"></i>Mensagens
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="historico-tab" data-bs-toggle="pill" data-bs-target="#historico" type="button" role="tab">
        <i class="bi bi-clock-history me-2"></i>Hist√≥rico
      </button>
    </li>
  </ul>

  <div class="tab-content" id="mainTabsContent">
    <!-- CLIENTES -->
    <div class="tab-pane fade show active" id="clientes" role="tabpanel">
      <div class="content-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
          <h3 style="margin:0;"><i class="bi bi-people-fill"></i> Gerenciar Clientes (Excel)</h3>
          <button class="btn-primary-custom" onclick="modalAdicionarCliente()">
            <i class="bi bi-person-plus-fill me-2"></i>Adicionar Cliente
          </button>
        </div>

        <div class="table-responsive">
          <table class="table" id="tabelaClientes">
            <thead>
              <tr>
                <th style="width:70px;">#</th>
                <th>Nome</th>
                <th>Empresa</th>
                <th>WhatsApp</th>
              </tr>
            </thead>
            <tbody id="tbodyClientes">
              <!-- preenchido via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- MENSAGENS -->
    <div class="tab-pane fade" id="mensagens" role="tabpanel">
      <div class="content-card">
        <h3 style="margin-bottom:32px;"><i class="bi bi-envelope-fill"></i> Criar Nova Mensagem</h3>

        <!-- Sele√ß√£o de clientes -->
        <div class="form-group">
          <label class="form-label">Selecione os Clientes *</label>
          <input type="text" class="form-control" id="buscaClientes" placeholder="Buscar por nome/empresa/telefone..." oninput="filtrarListaClientes()">
          <div id="listaSelecionavel" style="margin-top:14px; display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:10px;"></div>

          <div class="badge-pill" style="margin-top:12px;">
            <span><i class="bi bi-check2-square me-2"></i>Selecionados</span>
            <strong><span id="qtdSelecionados">0</span></strong>
          </div>
        </div>

        <form id="formNovaMensagem" enctype="multipart/form-data">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:24px;margin-bottom:24px;">
            <div class="form-group" style="margin-bottom:0;">
              <label class="form-label">T√≠tulo da Mensagem *</label>
              <input type="text" class="form-control" id="tituloMensagem" placeholder="Ex: Promo√ß√£o do m√™s" required>
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label class="form-label">Quantidade de clientes</label>
              <input type="number" class="form-control" id="quantidadeClientes" value="0" readonly>
              <small style="color:var(--text-secondary)">Preenchido automaticamente conforme a sele√ß√£o</small>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Texto da Mensagem *</label>
            <textarea class="form-control" id="textoMensagem" placeholder="Digite sua mensagem...&#10;Use {nome} para personalizar com o nome do cliente." required></textarea>
            <small style="color:var(--text-secondary);display:block;margin-top:8px;">üí° Use <code>{nome}</code> para inserir o nome do cliente automaticamente</small>
          </div>

          <div class="form-group">
            <label class="form-label">Imagem (opcional)</label>
            <input type="file" class="form-control" id="imagemMensagem" accept="image/*" onchange="previewImage(this)">
            <small style="color:var(--text-secondary);display:block;margin-top:8px;">PNG, JPG, JPEG, GIF, WEBP (m√°x. 5MB)</small>
            <div id="imagePreview"></div>
          </div>

          <div style="text-align:center;margin-top:40px;">
            <button type="button" class="btn-success-custom" onclick="enviarMensagem()" style="max-width:420px;margin:0 auto;">
              <i class="bi bi-send-fill me-2"></i>Enviar Mensagem Agora
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- HIST√ìRICO -->
    <div class="tab-pane fade" id="historico" role="tabpanel">
      <div class="content-card">
        <h3 style="margin-bottom:24px;"><i class="bi bi-clock-history"></i> Hist√≥rico de Envios</h3>
        <div id="listaHistorico"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Adicionar Cliente -->
<div class="modal fade" id="modalAdicionarCliente" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title"><i class="bi bi-person-plus-fill me-2"></i>Adicionar Cliente (Excel)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="formAdicionarCliente">
        <div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-control" id="nomeCliente" placeholder="Nome completo" required></div>
        <div class="form-group"><label class="form-label">Empresa</label><input type="text" class="form-control" id="empresaCliente" placeholder="Opcional"></div>
        <div class="form-group"><label class="form-label">WhatsApp *</label><input type="text" class="form-control" id="telefoneCliente" placeholder="21999999999" required><small style="color:var(--text-secondary);display:block;margin-top:8px;">Apenas n√∫meros (DDD + n√∫mero)</small></div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary-custom" data-bs-dismiss="modal">Cancelar</button>
      <button type="button" class="btn-primary-custom" onclick="adicionarCliente()"><i class="bi bi-check-circle me-2"></i>Adicionar</button>
    </div>
  </div></div>
</div>

<!-- Modal Logs -->
<div class="modal fade" id="modalVerLogs" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title"><i class="bi bi-list-ul me-2"></i>Logs de Envio: <span id="tituloMensagemLogs"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body"><div id="listaLogs"></div></div>
    <div class="modal-footer"><button type="button" class="btn-secondary-custom" data-bs-dismiss="modal">Fechar</button></div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let CLIENTES = [];
let SELECIONADOS = new Set(); // guarda ids (√≠ndice do Excel)

document.addEventListener('DOMContentLoaded', () => {
  carregarDashboard();
  carregarClientes();
  carregarHistorico();
});

// -------- Dashboard
function carregarDashboard(){
  fetch('/api/clientes-msg/dashboard').then(r=>r.json()).then(data=>{
    if(data.success){
      document.getElementById('totalClientes').textContent = data.stats.total_clientes;
      document.getElementById('totalMensagens').textContent = data.stats.total_mensagens;
      document.getElementById('totalEnviadas').textContent = data.stats.total_enviadas;
    }
  });
}

// -------- Clientes (Excel)
function carregarClientes(){
  fetch('/api/clientes-msg/clientes').then(r=>r.json()).then(data=>{
    if(!data.success) return Swal.fire('Erro', data.message || 'Falha ao carregar clientes', 'error');

    CLIENTES = data.clientes || [];
    // Tabela
    const tbody = document.getElementById('tbodyClientes');
    tbody.innerHTML = '';
    CLIENTES.forEach(c=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${c.id}</td>
        <td>${escapeHtml(c.nome)}</td>
        <td>${escapeHtml(c.empresa || '')}</td>
        <td>${escapeHtml(c.whatzap)}</td>
      `;
      tbody.appendChild(tr);
    });

    // Selecion√°vel
    montarListaSelecionavel(CLIENTES);
    atualizarContadorSelecionados();
  });
}

function montarListaSelecionavel(lista){
  const cont = document.getElementById('listaSelecionavel');
  cont.innerHTML = '';
  lista.forEach(c=>{
    const card = document.createElement('label');
    card.className = 'badge-pill';
    card.innerHTML = `
      <div>
        <strong>${escapeHtml(c.nome)}</strong><br>
        <small style="color:var(--text-secondary)">${escapeHtml(c.empresa || '-')}&nbsp;&middot;&nbsp;${escapeHtml(c.whatzap)}</small>
      </div>
      <input type="checkbox" style="width:18px;height:18px" onchange="toggleSelecionado(${c.id}, this.checked)" ${SELECIONADOS.has(c.id)?'checked':''}>
    `;
    cont.appendChild(card);
  });
}

function filtrarListaClientes(){
  const q = (document.getElementById('buscaClientes').value || '').toLowerCase();
  const filtrados = CLIENTES.filter(c=>{
    return (c.nome||'').toLowerCase().includes(q) ||
           (c.empresa||'').toLowerCase().includes(q) ||
           (c.whatzap||'').toLowerCase().includes(q);
  });
  montarListaSelecionavel(filtrados);
}

function toggleSelecionado(id, checked){
  if(checked) SELECIONADOS.add(id);
  else SELECIONADOS.delete(id);
  atualizarContadorSelecionados();
}

function atualizarContadorSelecionados(){
  const qtd = SELECIONADOS.size;
  document.getElementById('qtdSelecionados').textContent = qtd;
  document.getElementById('quantidadeClientes').value = qtd;
}

function modalAdicionarCliente(){
  document.getElementById('formAdicionarCliente').reset();
  new bootstrap.Modal(document.getElementById('modalAdicionarCliente')).show();
}

function adicionarCliente(){
  const nome = document.getElementById('nomeCliente').value.trim();
  const empresa = document.getElementById('empresaCliente').value.trim();
  const whatzap = document.getElementById('telefoneCliente').value.trim();
  if(!(nome && whatzap)) return Swal.fire('Aten√ß√£o','Preencha Nome e WhatsApp','warning');

  showLoading();
  fetch('/api/clientes-msg/clientes/adicionar', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({nome, empresa, whatzap})
  }).then(r=>r.json()).then(d=>{
    hideLoading();
    if(d.success){
      Swal.fire({icon:'success',title:'Cliente adicionado ao Excel!',timer:1600,showConfirmButton:false});
      bootstrap.Modal.getInstance(document.getElementById('modalAdicionarCliente')).hide();
      carregarClientes(); carregarDashboard();
    }else{
      Swal.fire('Erro', d.message || 'Falha ao adicionar', 'error');
    }
  }).catch(()=>{
    hideLoading();
    Swal.fire('Erro','Erro ao adicionar cliente','error');
  });
}

// -------- Mensagens
function previewImage(input){
  const preview = document.getElementById('imagePreview');
  if(input.files && input.files[0]){
    const reader = new FileReader();
    reader.onload = e=>{
      preview.innerHTML = `
        <img src="${e.target.result}" style="max-width:100%;max-height:300px;border:1px solid var(--border);border-radius:8px;margin-top:12px" alt="Preview">
        <div style="text-align:center;margin-top:16px;">
          <button type="button" class="btn-secondary-custom" onclick="removerImagem()">
            <i class="bi bi-x-circle me-1"></i>Remover Imagem
          </button>
        </div>`;
    };
    reader.readAsDataURL(input.files[0]);
  }
}
function removerImagem(){
  document.getElementById('imagemMensagem').value = '';
  document.getElementById('imagePreview').innerHTML = '';
}

function enviarMensagem(){
  const titulo = document.getElementById('tituloMensagem').value.trim();
  const texto = document.getElementById('textoMensagem').value.trim();
  if(!(titulo && texto)) return Swal.fire('Aten√ß√£o','Preencha t√≠tulo e texto','warning');
  if(SELECIONADOS.size === 0) return Swal.fire('Aten√ß√£o','Selecione ao menos 1 cliente','warning');

  // Monta destinat√°rios a partir dos IDs escolhidos
  const mapa = new Map(CLIENTES.map(c=>[c.id, c]));
  const selecionados = Array.from(SELECIONADOS).map(id=>{
    const c = mapa.get(id);
    return { id: c.id, nome: c.nome, whatzap: c.whatzap };
  });

  const formData = new FormData();
  formData.append('titulo', titulo);
  formData.append('texto', texto);
  formData.append('destinatarios', JSON.stringify(selecionados));

  const img = document.getElementById('imagemMensagem').files[0];
  if(img) formData.append('imagem', img);

  showLoading();
  fetch('/api/clientes-msg/mensagens/enviar', { method:'POST', body: formData })
    .then(r=>r.json()).then(d=>{
      hideLoading();
      if(d.success){
        const s = d.stats;
        Swal.fire({
          icon: s.falha===0 ? 'success':'warning',
          title:'Envio Conclu√≠do!',
          html:`<div style="text-align:left;">
            <p><b>Total:</b> ${s.total}</p>
            <p style="color:var(--success)"><b>Sucesso:</b> ${s.sucesso}</p>
            ${s.falha>0?`<p style="color:var(--danger)"><b>Falhas:</b> ${s.falha}</p>`:''}
          </div>`,
          confirmButtonText:'Ver Hist√≥rico'
        }).then(res=>{ if(res.isConfirmed) document.getElementById('historico-tab').click(); });

        document.getElementById('formNovaMensagem').reset();
        SELECIONADOS.clear();
        montarListaSelecionavel(CLIENTES);
        atualizarContadorSelecionados();
        removerImagem(); carregarDashboard(); carregarHistorico();
      }else{
        Swal.fire('Erro', d.message || 'Falha no envio', 'error');
      }
    }).catch(()=>{
      hideLoading();
      Swal.fire('Erro','Erro ao enviar mensagem','error');
    });
}

// -------- Hist√≥rico
function carregarHistorico(){
  fetch('/api/clientes-msg/historico').then(r=>r.json()).then(data=>{
    const container = document.getElementById('listaHistorico');
    if(!data.success) return;
    if((data.mensagens||[]).length===0){
      container.innerHTML = `<div class="empty-state" style="padding:60px 20px;">
        <i class="bi bi-inbox"></i><p>Nenhuma mensagem enviada ainda</p>
      </div>`;
      return;
    }
    container.innerHTML = '';
    data.mensagens.forEach(msg=>{
      const div = document.createElement('div');
      div.className = 'content-card';
      div.style.padding = '20px';
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
          <div>
            <h5 style="margin:0 0 8px 0;">${msg.tem_imagem?'<i class="bi bi-image me-2"></i>':''}${escapeHtml(msg.titulo)}</h5>
            <p style="color:var(--text-secondary);font-size:14px;margin:0;">${(msg.texto||'').length>160?(escapeHtml(msg.texto.substring(0,160))+'...'):escapeHtml(msg.texto)}</p>
          </div>
          <span class="badge" style="background:${statusColor(msg.status)};color:#fff;">${traduzirStatus(msg.status)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
          <small style="color:var(--text-secondary);">
            <i class="bi bi-send me-1"></i>${msg.total_enviados}/${msg.total_destinatarios} |
            <i class="bi bi-calendar me-1"></i>${formatarData(msg.sent_at || msg.created_at)}
          </small>
          <button type="button" class="btn-primary-custom" style="padding:6px 16px;font-size:12px;" onclick="verLogs(${msg.id}, '${escapeHtml(msg.titulo)}')">
            <i class="bi bi-list-ul me-1"></i>Ver Logs
          </button>
        </div>`;
      container.appendChild(div);
    });
  });
}

function verLogs(mensagemId,titulo){
  document.getElementById('tituloMensagemLogs').textContent = titulo;
  showLoading();
  fetch(`/api/clientes-msg/mensagem/${mensagemId}/logs`).then(r=>r.json()).then(d=>{
    hideLoading();
    if(!d.success) return;
    const container = document.getElementById('listaLogs');
    if(d.logs.length===0){container.innerHTML='<p class="text-muted">Nenhum log encontrado</p>'; return;}
    let html = '<div class="table-responsive"><table class="table"><thead><tr><th>Cliente</th><th>Telefone</th><th>Status</th><th>Data</th><th>Erro</th></tr></thead><tbody>';
    d.logs.forEach(l=>{
      html += `<tr>
        <td>${escapeHtml(l.nome)}</td>
        <td>${escapeHtml(l.telefone)}</td>
        <td><span class="badge" style="background:${l.status==='success'?'#10b981':'#ef4444'};color:#fff;">${l.status==='success'?'Enviado':'Erro'}</span></td>
        <td>${formatarData(l.sent_at)}</td>
        <td>${l.erro ? escapeHtml(l.erro) : '-'}</td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    container.innerHTML = html;
    new bootstrap.Modal(document.getElementById('modalVerLogs')).show();
  }).catch(()=>{hideLoading(); Swal.fire('Erro','Erro ao carregar logs','error');});
}

// -------- Utilit√°rios
function formatarData(d){
  if(!d) return '-';
  const dt = new Date(d);
  return dt.toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
}
function traduzirStatus(s){
  return ({pendente:'Pendente',enviando:'Enviando...',enviada:'Enviada',enviada_com_erros:'Enviada c/ Erros',falhou:'Falhou'})[s]||s;
}
function statusColor(s){
  return ({pendente:'#f59e0b',enviando:'#2563eb',enviada:'#10b981',enviada_com_erros:'#ef4444',falhou:'#ef4444'})[s]||'#6b7280';
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function showLoading(){document.getElementById('loadingOverlay').style.display='flex'}
function hideLoading(){document.getElementById('loadingOverlay').style.display='none'}
</script>
</body>
</html>
